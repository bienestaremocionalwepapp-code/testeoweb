<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TEST - Normalizaci√≥n Completa</title>
    <style>
        body { font-family: Arial; max-width: 900px; margin: 20px auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1 { color: #667eea; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9em; }
        .box { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 10px; border: 2px solid #e0e0e0; }
        button { background: #667eea; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: 600; }
        button:hover { background: #5568d3; }
        .success { color: #28a745; font-weight: bold; padding: 10px; background: #d4edda; border-radius: 5px; margin: 5px 0; }
        .error { color: #dc3545; font-weight: bold; padding: 10px; background: #f8d7da; border-radius: 5px; margin: 5px 0; }
        .warning { color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin: 5px 0; }
        .info { color: #004085; padding: 10px; background: #cce5ff; border-radius: 5px; margin: 5px 0; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 0.9em; }
        .data-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .data-box { background: white; padding: 15px; border-radius: 8px; border: 2px solid #667eea; }
        .data-box h4 { color: #667eea; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ TEST - Con Normalizaci√≥n Total</h1>
        <p class="subtitle">‚úÖ Coma (,) se convierte autom√°ticamente a punto (.)</p>
        
        <div class="box">
            <h2>üìä Paso 1: Leer Datos de Google Sheets</h2>
            <button onclick="leerDatosReales()">üîç Leer Datos con Normalizaci√≥n</button>
            <div id="datosReales"></div>
        </div>

        <div class="box">
            <h2>üíæ Paso 2: Comparar con localStorage</h2>
            <button onclick="compararDatos()">üîÑ Comparar Sheets vs Cache</button>
            <div id="comparacion"></div>
        </div>

        <div class="box">
            <h2>‚úÖ Paso 3: Guardar en localStorage</h2>
            <button onclick="guardarEnCache()">üíæ Guardar en Cache</button>
            <button onclick="limpiarCache()" style="background: #dc3545;">üóëÔ∏è Limpiar Cache</button>
            <div id="guardadoStatus"></div>
        </div>

        <div class="box">
            <h2>üì± Paso 4: Ver localStorage</h2>
            <button onclick="mostrarCache()">üëÅÔ∏è Ver Cache Actual</button>
            <div id="cacheActual"></div>
        </div>
    </div>

    <script>
        const SHEET_ID = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
        
        let datosDesdeSheets = {
            dias: null,
            capital: null,
            interes: null,
            banner: null
        };

        // ============================================
        // 1. FUNCI√ìN DE NORMALIZACI√ìN
        // ============================================
        function normalizarNumeroSheets(valor) {
            // Si ya es n√∫mero, devolverlo directo
            if (typeof valor === 'number') {
                return isFinite(valor) ? valor : NaN;
            }
            
            // Si es null, undefined o string vac√≠o
            if (valor == null || valor === '') {
                return NaN;
            }
            
            // Convertir a string y limpiar espacios
            let texto = String(valor).trim();
            
            // Eliminar s√≠mbolo % si existe
            texto = texto.replace(/%/g, '');
            
            // ‚úÖ CONVERTIR TODAS LAS COMAS A PUNTO
            texto = texto.replace(/,/g, '.');
            
            // Si hay m√∫ltiples puntos, mantener solo el √∫ltimo como decimal
            const partes = texto.split('.');
            if (partes.length > 2) {
                texto = partes.slice(0, -1).join('') + '.' + partes[partes.length - 1];
            }
            
            const numero = parseFloat(texto);
            
            // Validar que sea n√∫mero v√°lido y finito
            return isNaN(numero) || !isFinite(numero) ? NaN : numero;
        }

        // ============================================
        // 2. FUNCIONES DE CACHE
        // ============================================
        function saveToCache(key, data) {
            const cacheData = {
                data: data,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(`simulador_${key}`, JSON.stringify(cacheData));
            console.log(`‚úÖ Guardado en cache: simulador_${key}`, data);
        }

        function getFromCache(key) {
            try {
                const cached = localStorage.getItem(`simulador_${key}`);
                if (!cached) return null;
                const cacheData = JSON.parse(cached);
                return cacheData.data;
            } catch (error) {
                console.error(`‚ùå Error al leer cache: ${key}`, error);
                return null;
            }
        }

        // ============================================
        // 3. LEER HOJA COMPLETA
        // ============================================
        async function leerHojaCompleta(nombreHoja) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${nombreHoja}`;
            
            console.log(`üì• Leyendo hoja: ${nombreHoja}`);
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            
            const text = await response.text();
            const jsonStr = text.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);[\s\S]*$/, '');
            const json = JSON.parse(jsonStr);
            
            return json.table.rows || [];
        }

        // ============================================
        // 4. LEER COLUMNA A - Con normalizaci√≥n
        // ============================================
        async function leerColumnaA(nombreHoja) {
            const rows = await leerHojaCompleta(nombreHoja);
            const valores = [];
            
            console.log(`\n=== ${nombreHoja} ===`);
            
            rows.forEach((row, idx) => {
                const valorRAW = row?.c?.[0]?.v;
                
                console.log(`  A${idx + 1}: ${valorRAW} (tipo: ${typeof valorRAW})`);
                
                // Saltar encabezado si es texto
                if (idx === 0 && isNaN(parseFloat(valorRAW))) {
                    console.log(`    ‚è≠Ô∏è ENCABEZADO`);
                    return;
                }
                
                // ‚úÖ NORMALIZAR
                const num = normalizarNumeroSheets(valorRAW);
                
                if (!isNaN(num)) {
                    valores.push(num);
                    console.log(`    ‚úÖ ${num}`);
                }
            });
            
            console.log(`‚úÖ ${nombreHoja}:`, valores);
            return valores;
        }

        // ============================================
        // 5. LEER INTERES - Con normalizaci√≥n y mapeo
        // ============================================
        async function leerInteres() {
            const rows = await leerHojaCompleta('Interes');
            const valores = [];
            
            console.log('\n========================================');
            console.log('INTERES CON NORMALIZACI√ìN');
            console.log('========================================');
            
            rows.forEach((row, idx) => {
                const valorRAW = row?.c?.[0]?.v;
                const formato = row?.c?.[0]?.f;
                
                console.log(`\nA${idx + 1}: ${valorRAW} (formato: ${formato})`);
                
                // Saltar encabezado
                if (idx === 0 && isNaN(parseFloat(valorRAW))) {
                    console.log(`  ‚è≠Ô∏è ENCABEZADO`);
                    return;
                }
                
                // ‚úÖ NORMALIZAR
                let num = normalizarNumeroSheets(valorRAW);
                
                if (isNaN(num)) {
                    console.log(`  ‚ùå No v√°lido`);
                    return;
                }
                
                console.log(`  ‚úÖ Normalizado: ${num}`);
                
                // Rechazar fechas
                if (num > 1000) {
                    console.log(`  ‚ùå FECHA rechazada`);
                    return;
                }
                
                // Detectar formato %
                if (formato && formato.includes('%')) {
                    num = num * 100;
                    console.log(`  ‚úÖ Convertido %: ${num}`);
                } else if (num > 0 && num < 1) {
                    num = num * 100;
                    console.log(`  ‚úÖ Convertido decimal: ${num}`);
                }
                
                // Validar rango
                if (num < 0 || num > 100) {
                    console.log(`  ‚ùå Fuera de rango`);
                    return;
                }
                
                valores.push(num);
                console.log(`  ‚úÖ AGREGADO: ${num}`);
            });
            
            console.log('\n‚úÖ Array Interes:', valores);
            
            // Mapeo con Dias
            const diasRows = await leerHojaCompleta('Dias');
            const diasValores = [];
            
            diasRows.forEach((row, idx) => {
                const valorRAW = row?.c?.[0]?.v;
                if (idx === 0 && isNaN(parseFloat(valorRAW))) return;
                const num = normalizarNumeroSheets(valorRAW);
                if (!isNaN(num)) diasValores.push(num);
            });
            
            const interesesObj = {};
            const minLength = Math.min(diasValores.length, valores.length);
            
            for (let i = 0; i < minLength; i++) {
                interesesObj[diasValores[i]] = valores[i];
            }
            
            console.log('‚úÖ Objeto mapeado:', interesesObj);
            console.log('========================================\n');
            
            return interesesObj;
        }

        // ============================================
        // 6. LEER BANNER
        // ============================================
        async function leerBanner() {
            const rows = await leerHojaCompleta('Banner');
            
            if (rows.length > 1) {
                const mensaje = rows[1]?.c?.[0]?.v || '';
                console.log(`‚úÖ Banner: "${mensaje}"`);
                
                return {
                    activo: mensaje.trim() !== '',
                    texto: mensaje
                };
            }
            
            return {
                activo: false,
                texto: ''
            };
        }

        // ============================================
        // 7. LEER TODOS LOS DATOS
        // ============================================
        async function leerDatosReales() {
            const div = document.getElementById('datosReales');
            div.innerHTML = '<p class="info">‚è≥ Leyendo datos con normalizaci√≥n autom√°tica...</p>';
            
            let html = '<h3>üìä Datos REALES:</h3>';
            html += '<p class="info">‚úÖ Comas (,) convertidas autom√°ticamente a punto (.)</p>';
            
            try {
                // DIAS
                html += '<p>üìÖ Leyendo Dias...</p>';
                const dias = await leerColumnaA('Dias');
                datosDesdeSheets.dias = dias;
                html += `<div class="success">‚úÖ DIAS: ${JSON.stringify(dias)}</div>`;
                
                // CAPITAL
                html += '<p>üí∞ Leyendo Capital...</p>';
                const capital = await leerColumnaA('Capital');
                datosDesdeSheets.capital = capital;
                html += `<div class="success">‚úÖ CAPITAL: ${JSON.stringify(capital)}</div>`;
                
                // INTERES
                html += '<p>üìä Leyendo Interes...</p>';
                const interes = await leerInteres();
                datosDesdeSheets.interes = interes;
                html += `<div class="success">‚úÖ INTERES:<pre>${JSON.stringify(interes, null, 2)}</pre></div>`;
                
                // BANNER
                html += '<p>üéå Leyendo Banner...</p>';
                const banner = await leerBanner();
                datosDesdeSheets.banner = banner;
                html += `<div class="success">‚úÖ BANNER: "${banner.texto}"</div>`;
                
                html += '<div class="success"><strong>üéâ Todos los datos normalizados correctamente</strong></div>';
                html += '<div class="info">üí° Abre la consola (F12) para ver el proceso detallado</div>';
                
            } catch (error) {
                html += `<div class="error">‚ùå Error: ${error.message}</div>`;
                console.error('Error completo:', error);
            }
            
            div.innerHTML = html;
        }

        // ============================================
        // 8. COMPARAR DATOS
        // ============================================
        async function compararDatos() {
            const div = document.getElementById('comparacion');
            
            if (!datosDesdeSheets.dias) {
                div.innerHTML = '<div class="warning">‚ö†Ô∏è Primero lee los datos (Paso 1)</div>';
                return;
            }
            
            const diasCache = getFromCache('dias');
            const capitalCache = getFromCache('capital');
            const interesCache = getFromCache('interes');
            const bannerCache = getFromCache('banner_config');
            
            let html = '<h3>üîÑ Comparaci√≥n:</h3><div class="data-compare">';
            
            // DIAS
            html += '<div class="data-box">';
            html += '<h4>üìÖ DIAS</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.dias, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (diasCache ? JSON.stringify(diasCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            // CAPITAL
            html += '<div class="data-box">';
            html += '<h4>üí∞ CAPITAL</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.capital, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (capitalCache ? JSON.stringify(capitalCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            // INTERES
            html += '<div class="data-box">';
            html += '<h4>üìä INTERES</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.interes, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (interesCache ? JSON.stringify(interesCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            // BANNER
            html += '<div class="data-box">';
            html += '<h4>üéå BANNER</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.banner, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (bannerCache ? JSON.stringify(bannerCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            html += '</div>';
            
            div.innerHTML = html;
        }

        // ============================================
        // 9. GUARDAR EN CACHE
        // ============================================
        async function guardarEnCache() {
            const div = document.getElementById('guardadoStatus');
            
            if (!datosDesdeSheets.dias) {
                div.innerHTML = '<div class="error">‚ùå Primero lee los datos (Paso 1)</div>';
                return;
            }
            
            div.innerHTML = '<p>üíæ Guardando...</p>';
            
            try {
                saveToCache('dias', datosDesdeSheets.dias);
                saveToCache('capital', datosDesdeSheets.capital);
                saveToCache('interes', datosDesdeSheets.interes);
                saveToCache('banner_config', datosDesdeSheets.banner);
                
                div.innerHTML = '<div class="success">‚úÖ Datos normalizados guardados en localStorage</div>';
                mostrarCache();
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // ============================================
        // 10. MOSTRAR CACHE
        // ============================================
        function mostrarCache() {
            const div = document.getElementById('cacheActual');
            
            const dias = getFromCache('dias');
            const capital = getFromCache('capital');
            const interes = getFromCache('interes');
            const banner = getFromCache('banner_config');
            
            div.innerHTML = `
                <h3>üì± localStorage Actual:</h3>
                <pre>DIAS:\n${dias ? JSON.stringify(dias, null, 2) : '‚ùå Vac√≠o'}\n\n` +
                `CAPITAL:\n${capital ? JSON.stringify(capital, null, 2) : '‚ùå Vac√≠o'}\n\n` +
                `INTERES:\n${interes ? JSON.stringify(interes, null, 2) : '‚ùå Vac√≠o'}\n\n` +
                `BANNER:\n${banner ? JSON.stringify(banner, null, 2) : '‚ùå Vac√≠o'}</pre>
            `;
        }

        // ============================================
        // 11. LIMPIAR CACHE
        // ============================================
        function limpiarCache() {
            if (confirm('¬øLimpiar TODO el localStorage?')) {
                localStorage.removeItem('simulador_dias');
                localStorage.removeItem('simulador_capital');
                localStorage.removeItem('simulador_interes');
                localStorage.removeItem('simulador_banner_config');
                alert('‚úÖ Cache limpiado');
                mostrarCache();
            }
        }

        // ============================================
        // 12. INICIALIZACI√ìN
        // ============================================
        window.addEventListener('load', () => {
            console.log('üß™ Test iniciado - NORMALIZACI√ìN TOTAL');
            console.log('üìä Sheet ID:', SHEET_ID);
            console.log('‚úÖ Coma (,) ‚Üí Punto (.) autom√°tico');
            mostrarCache();
        });
    </script>
</body>
</html>

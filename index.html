<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TEST - Datos REALES de Google Sheets</title>
    <style>
        body { font-family: Arial; max-width: 900px; margin: 20px auto; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        h1 { color: #667eea; text-align: center; }
        .box { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 10px; border: 2px solid #e0e0e0; }
        button { background: #667eea; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: 600; }
        button:hover { background: #5568d3; }
        .success { color: #28a745; font-weight: bold; padding: 10px; background: #d4edda; border-radius: 5px; margin: 5px 0; }
        .error { color: #dc3545; font-weight: bold; padding: 10px; background: #f8d7da; border-radius: 5px; margin: 5px 0; }
        .warning { color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin: 5px 0; }
        pre { background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 0.9em; }
        .data-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .data-box { background: white; padding: 15px; border-radius: 8px; border: 2px solid #667eea; }
        .data-box h4 { color: #667eea; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ TEST - Leer Datos REALES de Google Sheets</h1>
        
        <div class="box">
            <h2>üìä Paso 1: Ver Datos en Google Sheets</h2>
            <button onclick="leerDatosReales()">üîç Leer Datos de Sheets</button>
            <div id="datosReales"></div>
        </div>

        <div class="box">
            <h2>üíæ Paso 2: Comparar con localStorage</h2>
            <button onclick="compararDatos()">üîÑ Comparar Sheets vs localStorage</button>
            <div id="comparacion"></div>
        </div>

        <div class="box">
            <h2>‚úÖ Paso 3: Guardar en localStorage</h2>
            <button onclick="guardarEnCache()">üíæ Guardar Datos Reales en Cache</button>
            <button onclick="limpiarCache()" style="background: #dc3545;">üóëÔ∏è Limpiar Cache</button>
            <div id="guardadoStatus"></div>
        </div>

        <div class="box">
            <h2>üì± Paso 4: Ver localStorage Actual</h2>
            <button onclick="mostrarCache()">üëÅÔ∏è Ver Cache</button>
            <div id="cacheActual"></div>
        </div>
    </div>

    <script>
        const SHEET_ID = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
        
        let datosDesdeSheets = {
            dias: null,
            capital: null,
            interes: null,
            banner: null
        };

        function saveToCache(key, data) {
            const cacheData = {
                data: data,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(`simulador_${key}`, JSON.stringify(cacheData));
            console.log(`‚úÖ Guardado en cache: simulador_${key}`, data);
        }

        function getFromCache(key) {
            try {
                const cached = localStorage.getItem(`simulador_${key}`);
                if (!cached) return null;
                const cacheData = JSON.parse(cached);
                return cacheData.data;
            } catch (error) {
                console.error(`‚ùå Error al leer cache: ${key}`, error);
                return null;
            }
        }

        // ============================================
        // Leer hoja completa
        // ============================================
        async function leerHojaCompleta(nombreHoja) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${nombreHoja}`;
            
            console.log(`üì• Leyendo hoja: ${nombreHoja}`);
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            
            const text = await response.text();
            const jsonStr = text.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);[\s\S]*$/, '');
            const json = JSON.parse(jsonStr);
            
            return json.table.rows || [];
        }

        // ============================================
        // Leer columna A simple
        // ============================================
        async function leerColumnaA(nombreHoja) {
            const rows = await leerHojaCompleta(nombreHoja);
            const valores = [];
            
            rows.forEach((row, idx) => {
                const valor = row?.c?.[0]?.v;
                console.log(`  Fila ${idx + 1}: ${valor}`);
                
                // Saltar encabezado si es texto
                if (idx === 0 && isNaN(parseFloat(valor))) {
                    console.log(`    ‚è≠Ô∏è Saltando encabezado`);
                    return;
                }
                
                const num = parseFloat(valor);
                if (!isNaN(num)) {
                    valores.push(num);
                }
            });
            
            console.log(`‚úÖ ${nombreHoja} valores finales:`, valores);
            return valores;
        }

        // ============================================
        // Leer Interes VERTICAL con mapeo por posici√≥n
        // ============================================
        async function leerInteres() {
            console.log('üìä Leyendo Interes con mapeo por posici√≥n...');
            
            // Leer Dias
            const rowsDias = await leerHojaCompleta('Dias');
            
            // Leer Interes
            const rowsInteres = await leerHojaCompleta('Interes');
            
            const interesesObj = {};
            const maxFilas = Math.max(rowsDias.length, rowsInteres.length);
            
            for (let i = 0; i < maxFilas; i++) {
                const filaNum = i + 1;
                
                // Leer valor de Dias (columna A)
                let diasValor = rowsDias[i]?.c?.[0]?.v;
                
                // Leer valor de Interes (columna A)
                let interesValor = rowsInteres[i]?.c?.[0]?.v;
                const interesFormato = rowsInteres[i]?.c?.[0]?.f;
                
                console.log(`  Fila ${filaNum}: Dias=${diasValor}, Interes=${interesValor}, Formato=${interesFormato}`);
                
                // Saltar encabezados
                if (i === 0 && (isNaN(parseFloat(diasValor)) || isNaN(parseFloat(interesValor)))) {
                    console.log(`    ‚è≠Ô∏è Saltando encabezado`);
                    continue;
                }
                
                const diasNum = parseFloat(diasValor);
                let interesNum = parseFloat(interesValor);
                
                if (isNaN(diasNum) || isNaN(interesNum)) {
                    console.log(`    ‚ö†Ô∏è Valores inv√°lidos`);
                    continue;
                }
                
                // Detectar formato porcentaje
                if (interesFormato && interesFormato.includes('%')) {
                    interesNum = interesNum * 100;
                    console.log(`    ‚úÖ Convertido %: ${interesValor} ‚Üí ${interesNum}`);
                } else if (interesNum > 0 && interesNum < 1) {
                    interesNum = interesNum * 100;
                    console.log(`    ‚úÖ Convertido decimal: ${interesValor} ‚Üí ${interesNum}`);
                }
                
                interesesObj[diasNum] = interesNum;
                console.log(`    ‚úÖ Mapeado: ${diasNum} d√≠as ‚Üí ${interesNum}%`);
            }
            
            console.log(`‚úÖ Objeto de intereses final:`, interesesObj);
            return interesesObj;
        }

        // Leer Banner (celda A2)
        async function leerBanner() {
            const rows = await leerHojaCompleta('Banner');
            
            if (rows.length > 1) {
                const mensaje = rows[1]?.c?.[0]?.v || '';
                console.log(`‚úÖ Banner mensaje:`, mensaje);
                
                return {
                    activo: mensaje.trim() !== '',
                    texto: mensaje
                };
            }
            
            return {
                activo: false,
                texto: ''
            };
        }

        async function leerDatosReales() {
            const div = document.getElementById('datosReales');
            div.innerHTML = '<p>‚è≥ Leyendo datos de Google Sheets...</p>';
            
            let html = '<h3>üìä Datos REALES le√≠dos de Google Sheets:</h3>';
            
            try {
                // DIAS
                html += '<p>üìÖ Leyendo Dias...</p>';
                const dias = await leerColumnaA('Dias');
                datosDesdeSheets.dias = dias;
                html += `<div class="success">‚úÖ DIAS: ${JSON.stringify(dias)}</div>`;
                
                // CAPITAL
                html += '<p>üí∞ Leyendo Capital...</p>';
                const capital = await leerColumnaA('Capital');
                datosDesdeSheets.capital = capital;
                html += `<div class="success">‚úÖ CAPITAL: ${JSON.stringify(capital)}</div>`;
                
                // INTERES (mapeo por posici√≥n de fila)
                html += '<p>üìä Leyendo Interes (mapeo por fila)...</p>';
                const interes = await leerInteres();
                datosDesdeSheets.interes = interes;
                html += `<div class="success">‚úÖ INTERES:<pre>${JSON.stringify(interes, null, 2)}</pre></div>`;
                
                // BANNER
                html += '<p>üéå Leyendo Banner...</p>';
                const banner = await leerBanner();
                datosDesdeSheets.banner = banner;
                html += `<div class="success">‚úÖ BANNER: "${banner.texto}"</div>`;
                
                html += '<div class="success"><strong>üéâ Todos los datos le√≠dos correctamente</strong></div>';
                
            } catch (error) {
                html += `<div class="error">‚ùå Error: ${error.message}</div>`;
                html += `<div class="warning">‚ö†Ô∏è Verifica que las hojas existan con datos en columna A</div>`;
            }
            
            div.innerHTML = html;
        }

        async function compararDatos() {
            const div = document.getElementById('comparacion');
            
            if (!datosDesdeSheets.dias) {
                div.innerHTML = '<div class="warning">‚ö†Ô∏è Primero lee los datos de Sheets (Paso 1)</div>';
                return;
            }
            
            const diasCache = getFromCache('dias');
            const capitalCache = getFromCache('capital');
            const interesCache = getFromCache('interes');
            const bannerCache = getFromCache('banner_config');
            
            let html = '<h3>üîÑ Comparaci√≥n:</h3><div class="data-compare">';
            
            // DIAS
            html += '<div class="data-box">';
            html += '<h4>üìÖ DIAS</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.dias, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (diasCache ? JSON.stringify(diasCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            // CAPITAL
            html += '<div class="data-box">';
            html += '<h4>üí∞ CAPITAL</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.capital, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (capitalCache ? JSON.stringify(capitalCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            // INTERES
            html += '<div class="data-box">';
            html += '<h4>üìä INTERES</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.interes, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (interesCache ? JSON.stringify(interesCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            // BANNER
            html += '<div class="data-box">';
            html += '<h4>üéå BANNER</h4>';
            html += '<strong>Google Sheets:</strong><pre>' + JSON.stringify(datosDesdeSheets.banner, null, 2) + '</pre>';
            html += '<strong>localStorage:</strong><pre>' + (bannerCache ? JSON.stringify(bannerCache, null, 2) : '‚ùå Vac√≠o') + '</pre>';
            html += '</div>';
            
            html += '</div>';
            
            div.innerHTML = html;
        }

        async function guardarEnCache() {
            const div = document.getElementById('guardadoStatus');
            
            if (!datosDesdeSheets.dias) {
                div.innerHTML = '<div class="error">‚ùå Primero lee los datos de Sheets (Paso 1)</div>';
                return;
            }
            
            div.innerHTML = '<p>üíæ Guardando en localStorage...</p>';
            
            try {
                saveToCache('dias', datosDesdeSheets.dias);
                saveToCache('capital', datosDesdeSheets.capital);
                saveToCache('interes', datosDesdeSheets.interes);
                saveToCache('banner_config', datosDesdeSheets.banner);
                
                div.innerHTML = '<div class="success">‚úÖ Todos los datos guardados en localStorage</div>';
                mostrarCache();
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Error al guardar: ${error.message}</div>`;
            }
        }

        function mostrarCache() {
            const div = document.getElementById('cacheActual');
            
            const dias = getFromCache('dias');
            const capital = getFromCache('capital');
            const interes = getFromCache('interes');
            const banner = getFromCache('banner_config');
            
            div.innerHTML = `
                <h3>üì± localStorage Actual:</h3>
                <pre>DIAS:\n${dias ? JSON.stringify(dias, null, 2) : '‚ùå Vac√≠o'}\n\n` +
                `CAPITAL:\n${capital ? JSON.stringify(capital, null, 2) : '‚ùå Vac√≠o'}\n\n` +
                `INTERES:\n${interes ? JSON.stringify(interes, null, 2) : '‚ùå Vac√≠o'}\n\n` +
                `BANNER:\n${banner ? JSON.stringify(banner, null, 2) : '‚ùå Vac√≠o'}</pre>
            `;
        }

        function limpiarCache() {
            if (confirm('¬øEst√°s seguro de limpiar TODO el localStorage?')) {
                localStorage.removeItem('simulador_dias');
                localStorage.removeItem('simulador_capital');
                localStorage.removeItem('simulador_interes');
                localStorage.removeItem('simulador_banner_config');
                alert('‚úÖ localStorage limpiado');
                mostrarCache();
            }
        }

        window.addEventListener('load', () => {
            console.log('üß™ Test iniciado - Interes VERTICAL');
            console.log('üìä Sheet ID:', SHEET_ID);
            mostrarCache();
        });
    </script>
</body>
</html>

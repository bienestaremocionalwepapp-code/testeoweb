<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SimPrÃ©stamo â€” Simulador Inteligente</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  /* â”€â”€â”€ TOKENS â”€â”€â”€ */
  :root {
    --bg:       #0a0d12;
    --surface:  #111620;
    --card:     #161c28;
    --border:   #1e2838;
    --accent:   #00d4aa;
    --accent2:  #0099ff;
    --warn:     #f59e0b;
    --danger:   #ef4444;
    --text:     #e8edf5;
    --muted:    #5a6a82;
    --soft:     #8fa0b8;
    --radius:   14px;
    --radius-sm:8px;
    --shadow:   0 8px 32px rgba(0,0,0,.45);
    --glow:     0 0 40px rgba(0,212,170,.12);
  }

  /* â”€â”€â”€ RESET â”€â”€â”€ */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 16px; -webkit-tap-highlight-color: transparent; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€â”€ FONDO MESH â”€â”€â”€ */
  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 0;
    background:
      radial-gradient(ellipse 60% 50% at 80% 10%, rgba(0,212,170,.07) 0%, transparent 65%),
      radial-gradient(ellipse 50% 40% at 10% 90%, rgba(0,153,255,.06) 0%, transparent 65%);
    pointer-events: none;
  }

  /* â”€â”€â”€ LAYOUT â”€â”€â”€ */
  .app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 0 16px 48px; }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 0 8px;
  }
  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.35rem; letter-spacing: -0.03em; }
  .logo span { color: var(--accent); }

  /* â”€â”€â”€ STATUS PILL â”€â”€â”€ */
  .status-pill {
    display: flex; align-items: center; gap: 7px;
    padding: 6px 12px; border-radius: 99px;
    font-size: .72rem; font-weight: 500; letter-spacing: .04em; text-transform: uppercase;
    border: 1px solid var(--border);
    background: var(--surface);
    transition: all .4s ease;
  }
  .status-pill.online  { border-color: rgba(0,212,170,.3); color: var(--accent); }
  .status-pill.offline { border-color: rgba(245,158,11,.3);  color: var(--warn); }
  .status-pill.syncing { border-color: rgba(0,153,255,.3);   color: var(--accent2); }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: currentColor;
    animation: pulse 1.8s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(.7)} }

  /* â”€â”€â”€ BANNER â”€â”€â”€ */
  .banner {
    display: none;
    align-items: center; gap: 10px;
    margin: 10px 0 6px;
    padding: 11px 16px;
    border-radius: var(--radius-sm);
    background: linear-gradient(135deg, rgba(0,212,170,.08) 0%, rgba(0,153,255,.06) 100%);
    border: 1px solid rgba(0,212,170,.2);
    font-size: .85rem; color: var(--accent);
    animation: slideDown .4s ease;
  }
  .banner.show { display: flex; }
  .banner-icon { font-size: 1rem; flex-shrink: 0; }
  @keyframes slideDown { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }

  /* â”€â”€â”€ SECTION TITLE â”€â”€â”€ */
  .section-title {
    font-family: 'Syne', sans-serif;
    font-size: .68rem; font-weight: 700;
    letter-spacing: .1em; text-transform: uppercase;
    color: var(--muted);
    margin: 28px 0 12px;
  }

  /* â”€â”€â”€ CARD â”€â”€â”€ */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
  }

  /* â”€â”€â”€ SELECTOR GRID â”€â”€â”€ */
  .selector-label {
    font-size: .78rem; font-weight: 500; color: var(--soft);
    margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
  }
  .selector-label svg { opacity: .6; }

  .chips {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin-bottom: 20px;
  }
  .chip {
    padding: 8px 16px;
    border-radius: 99px;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--soft);
    font-size: .83rem; font-weight: 500;
    cursor: pointer;
    transition: all .18s ease;
    user-select: none;
  }
  .chip:hover { border-color: var(--accent); color: var(--text); }
  .chip.active {
    border-color: var(--accent);
    background: rgba(0,212,170,.12);
    color: var(--accent);
    font-weight: 600;
  }

  /* â”€â”€â”€ CAPITAL CHIPS (grid 3 cols) â”€â”€â”€ */
  .chips.capital { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .chips.capital .chip { text-align: center; border-radius: var(--radius-sm); padding: 10px 8px; }

  /* â”€â”€â”€ DIVIDER â”€â”€â”€ */
  .divider { height: 1px; background: var(--border); margin: 4px 0 20px; }

  /* â”€â”€â”€ CALCULAR BTN â”€â”€â”€ */
  .btn-calc {
    width: 100%;
    padding: 16px;
    border-radius: var(--radius);
    border: none;
    background: linear-gradient(135deg, var(--accent) 0%, #00b890 100%);
    color: #001a14;
    font-family: 'Syne', sans-serif;
    font-size: 1rem; font-weight: 700;
    letter-spacing: .02em;
    cursor: pointer;
    transition: all .2s ease;
    box-shadow: 0 4px 20px rgba(0,212,170,.25);
    display: flex; align-items: center; justify-content: center; gap: 8px;
    position: relative; overflow: hidden;
  }
  .btn-calc:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(0,212,170,.35); }
  .btn-calc:active { transform: translateY(0); }
  .btn-calc:disabled { opacity: .4; cursor: not-allowed; transform: none; }
  .btn-calc .ripple {
    position: absolute; border-radius: 50%;
    background: rgba(255,255,255,.25);
    transform: scale(0);
    animation: ripple .5s linear;
    pointer-events: none;
  }
  @keyframes ripple { to{ transform:scale(4); opacity:0; } }

  /* â”€â”€â”€ RESULTADO â”€â”€â”€ */
  #resultado { overflow: hidden; transition: all .35s ease; }

  .result-card {
    margin-top: 20px;
    background: var(--card);
    border: 1px solid rgba(0,212,170,.25);
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--glow), var(--shadow);
    animation: fadeUp .4s ease;
  }
  @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

  .result-header {
    background: linear-gradient(135deg, rgba(0,212,170,.12) 0%, rgba(0,153,255,.08) 100%);
    border-bottom: 1px solid rgba(0,212,170,.15);
    padding: 18px 20px;
    text-align: center;
  }
  .result-header .label { font-size: .72rem; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; margin-bottom: 6px; }
  .result-header .amount {
    font-family: 'Syne', sans-serif;
    font-size: 2.4rem; font-weight: 800; color: var(--accent);
    letter-spacing: -.03em; line-height: 1;
  }
  .result-header .sub { font-size: .78rem; color: var(--soft); margin-top: 4px; }

  .result-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 0;
  }
  .result-item {
    padding: 16px 18px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }
  .result-item:nth-child(2n) { border-right: none; }
  .result-item:nth-last-child(-n+2) { border-bottom: none; }
  .result-item .ri-label { font-size: .7rem; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; margin-bottom: 5px; }
  .result-item .ri-value {
    font-family: 'Syne', sans-serif;
    font-size: 1.15rem; font-weight: 700; color: var(--text);
  }
  .result-item .ri-value.accent { color: var(--accent); }
  .result-item .ri-value.gold   { color: #fbbf24; }

  /* â”€â”€â”€ CACHE BADGE â”€â”€â”€ */
  .cache-badge {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    padding: 10px;
    background: var(--surface);
    font-size: .7rem; color: var(--muted);
  }
  .cache-badge .dot { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); }

  /* â”€â”€â”€ SYNC PANEL (admin) â”€â”€â”€ */
  .sync-toggle {
    display: flex; align-items: center; justify-content: center; gap: 7px;
    width: 100%;
    margin-top: 28px;
    background: none; border: 1.5px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 11px;
    color: var(--muted); font-size: .78rem; font-weight: 500;
    cursor: pointer; transition: all .2s;
  }
  .sync-toggle:hover { border-color: var(--soft); color: var(--soft); }
  .sync-toggle svg { transition: transform .3s; }
  .sync-toggle.open svg { transform: rotate(180deg); }

  .sync-panel {
    display: none;
    flex-direction: column; gap: 10px;
    margin-top: 10px;
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    animation: fadeUp .25s ease;
  }
  .sync-panel.show { display: flex; }

  .sync-row {
    display: flex; align-items: center; justify-content: space-between;
    gap: 10px;
  }
  .sync-info { font-size: .78rem; color: var(--soft); }
  .sync-info strong { color: var(--text); display: block; font-size: .82rem; }

  .btn-sync {
    flex-shrink: 0;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    border: 1.5px solid rgba(0,153,255,.4);
    background: rgba(0,153,255,.08);
    color: var(--accent2);
    font-size: .78rem; font-weight: 600;
    cursor: pointer; transition: all .2s;
    white-space: nowrap;
  }
  .btn-sync:hover { background: rgba(0,153,255,.16); }
  .btn-sync:disabled { opacity:.4; cursor: not-allowed; }

  /* LOG */
  .sync-log {
    font-size: .72rem;
    background: var(--bg);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    color: var(--muted);
    line-height: 1.8;
    max-height: 120px;
    overflow-y: auto;
    display: none;
  }
  .sync-log.show { display: block; }
  .log-ok   { color: var(--accent); }
  .log-warn { color: var(--warn); }
  .log-err  { color: var(--danger); }
  .log-info { color: var(--accent2); }

  /* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
  .empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
    font-size: .85rem;
  }
  .empty .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: .4; }

  /* â”€â”€â”€ SKELETON â”€â”€â”€ */
  .skeleton {
    background: linear-gradient(90deg, var(--surface) 25%, var(--card) 50%, var(--surface) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.2s infinite;
    border-radius: 99px; height: 36px;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

  /* â”€â”€â”€ TOAST â”€â”€â”€ */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(60px);
    background: var(--surface); border: 1px solid var(--border);
    padding: 11px 20px; border-radius: 99px;
    font-size: .82rem; color: var(--text);
    box-shadow: 0 8px 24px rgba(0,0,0,.5);
    transition: transform .3s cubic-bezier(.34,1.56,.64,1);
    white-space: nowrap; z-index: 100;
  }
  #toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€â”€ PROGRESS BAR â”€â”€â”€ */
  .progress-bar {
    height: 2px; background: var(--border); border-radius: 99px;
    margin: 12px 0 0; overflow: hidden;
  }
  .progress-fill {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 99px;
    transition: width .4s ease;
  }

  /* â”€â”€â”€ MOBILE FINE TUNE â”€â”€â”€ */
  @media (max-width: 360px) {
    .result-header .amount { font-size: 2rem; }
    .chips.capital { grid-template-columns: repeat(2,1fr); }
  }
</style>
</head>
<body>

<div class="app">

  <!-- â”€â”€â”€ HEADER â”€â”€â”€ -->
  <header class="header">
    <div class="logo">Sim<span>PrÃ©stamo</span></div>
    <div class="status-pill" id="statusPill">
      <div class="status-dot"></div>
      <span id="statusText">â€”</span>
    </div>
  </header>

  <!-- â”€â”€â”€ BANNER â”€â”€â”€ -->
  <div class="banner" id="banner">
    <span class="banner-icon">ðŸ“¢</span>
    <span id="bannerText"></span>
  </div>

  <!-- â”€â”€â”€ SIMULADOR â”€â”€â”€ -->
  <p class="section-title">Simulador de prÃ©stamo</p>

  <div class="card">

    <!-- PLAZO -->
    <div class="selector-label">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Plazo (dÃ­as)
    </div>
    <div class="chips" id="chipsPlazos">
      <div class="skeleton" style="width:80px"></div>
      <div class="skeleton" style="width:80px"></div>
      <div class="skeleton" style="width:80px"></div>
    </div>

    <div class="divider"></div>

    <!-- CAPITAL -->
    <div class="selector-label">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      Capital solicitado
    </div>
    <div class="chips capital" id="chipsCapital">
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
      <div class="skeleton"></div>
    </div>

    <button class="btn-calc" id="btnCalc" disabled onclick="calcular(event)">
      Calcular prÃ©stamo
    </button>
  </div>

  <!-- â”€â”€â”€ RESULTADO â”€â”€â”€ -->
  <div id="resultado"></div>

  <!-- â”€â”€â”€ SYNC PANEL (admin/tÃ©cnico) â”€â”€â”€ -->
  <button class="sync-toggle" id="syncToggle" onclick="toggleSync()">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="6 9 12 3 18 9"/><polyline points="18 15 12 21 6 15"/>
    </svg>
    SincronizaciÃ³n de datos
  </button>

  <div class="sync-panel" id="syncPanel">

    <div class="sync-row">
      <div class="sync-info">
        <strong id="syncCacheInfo">Cargandoâ€¦</strong>
        Ãšltima sync: <span id="syncLastTime">â€”</span>
      </div>
      <button class="btn-sync" id="btnSync" onclick="sincronizar()">
        â†» Sincronizar
      </button>
    </div>

    <div class="progress-bar" id="progressBar" style="display:none">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="sync-log" id="syncLog"></div>

  </div>

</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€ -->
<div id="toast"></div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
/* ============================================
   CONFIG
   ============================================ */
const SHEET_ID   = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
const CACHE_TTL  = 12 * 60 * 60 * 1000; // 12 h
const CACHE_KEYS = { dias:'dias', capital:'capital', interes:'interes', banner:'banner' };

/* ============================================
   STATE
   ============================================ */
let state = {
  plazo:   null,
  capital: null,
  cache: { dias:[], capital:[], interes:{}, banner:{activo:false,texto:''} }
};

/* ============================================
   UTILIDADES
   ============================================ */
const $ = id => document.getElementById(id);

function fmt(n) {
  return '$' + n.toLocaleString('es-MX', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function toast(msg, duration = 2600) {
  const el = $('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), duration);
}

function log(msg, type = 'info') {
  const el = $('syncLog');
  el.classList.add('show');
  const span = document.createElement('span');
  span.className = `log-${type}`;
  const now = new Date().toLocaleTimeString('es-MX', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  span.textContent = `[${now}] ${msg}\n`;
  el.appendChild(span);
  el.scrollTop = el.scrollHeight;
}

function setProgress(pct) {
  const bar  = $('progressBar');
  const fill = $('progressFill');
  if (pct === null) { bar.style.display = 'none'; return; }
  bar.style.display = 'block';
  fill.style.width  = pct + '%';
}

/* ============================================
   CACHÃ‰: localStorage wrapper
   ============================================ */
function cacheSet(key, data) {
  try {
    localStorage.setItem('sp_' + key, JSON.stringify({ data, ts: Date.now() }));
  } catch(e) { console.warn('Cache write error', e); }
}

function cacheGet(key) {
  try {
    const raw = localStorage.getItem('sp_' + key);
    if (!raw) return null;
    return JSON.parse(raw);           // { data, ts }
  } catch(e) { return null; }
}

function cacheIsStale(key) {
  const item = cacheGet(key);
  if (!item) return true;
  return (Date.now() - item.ts) > CACHE_TTL;
}

function cacheLastSync() {
  // Toma el timestamp mÃ¡s reciente entre las 4 claves
  let latest = null;
  for (const k of Object.values(CACHE_KEYS)) {
    const item = cacheGet(k);
    if (item && (!latest || item.ts > latest)) latest = item.ts;
  }
  return latest;
}

/* ============================================
   STATUS INDICATOR
   ============================================ */
function updateStatus(mode) {
  const pill = $('statusPill');
  const txt  = $('statusText');
  pill.className = 'status-pill ' + mode;
  txt.textContent = mode === 'online' ? 'Online' : mode === 'syncing' ? 'Sincronizando' : 'Offline';
}

/* ============================================
   NORMALIZACIÃ“N (datos de Sheets)
   ============================================ */
function normalizar(v) {
  if (typeof v === 'number') return isFinite(v) ? v : NaN;
  if (!v) return NaN;
  let s = String(v).trim().replace(/%/g,'').replace(/,/g,'.');
  const parts = s.split('.');
  if (parts.length > 2) s = parts.slice(0,-1).join('') + '.' + parts[parts.length-1];
  const n = parseFloat(s);
  return isNaN(n) || !isFinite(n) ? NaN : n;
}

/* ============================================
   FETCH SHEETS
   ============================================ */
async function fetchSheet(sheet) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheet}`;
  const r   = await fetch(url);
  if (!r.ok) throw new Error(`HTTP ${r.status} en hoja "${sheet}"`);
  const txt = await r.text();
  const json = JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/,'').replace(/\);[\s\S]*$/,''));
  return json.table.rows || [];
}

async function fetchColA(sheet) {
  const rows = await fetchSheet(sheet);
  return rows
    .filter((row, i) => { if (i===0 && isNaN(parseFloat(row?.c?.[0]?.v))) return false; return true; })
    .map(row => normalizar(row?.c?.[0]?.v))
    .filter(n => !isNaN(n));
}

async function fetchInteres(dias) {
  const rows = await fetchSheet('Interes');
  const vals = [];
  rows.forEach((row, i) => {
    if (i===0 && isNaN(parseFloat(row?.c?.[0]?.v))) return;
    let n = normalizar(row?.c?.[0]?.v);
    if (isNaN(n) || n > 1000) return;
    const fmt = row?.c?.[0]?.f || '';
    if (fmt.includes('%') || (n > 0 && n < 1)) n *= 100;
    if (n < 0 || n > 100) return;
    vals.push(n);
  });
  const obj = {};
  const len = Math.min(dias.length, vals.length);
  for (let i = 0; i < len; i++) obj[dias[i]] = vals[i];
  return obj;
}

async function fetchBanner() {
  const rows = await fetchSheet('Banner');
  if (rows.length > 1) {
    const txt = rows[1]?.c?.[0]?.v || '';
    return { activo: txt.trim() !== '', texto: txt };
  }
  return { activo: false, texto: '' };
}

/* ============================================
   SINCRONIZACIÃ“N PRINCIPAL
   ============================================ */
async function sincronizar(silent = false) {
  if (!navigator.onLine) {
    if (!silent) { toast('ðŸ“µ Sin conexiÃ³n â€” usando datos guardados'); }
    updateStatus('offline');
    return false;
  }

  updateStatus('syncing');
  $('btnSync').disabled = true;
  setProgress(5);
  if (!silent) log('Iniciando sincronizaciÃ³n con Google Sheetsâ€¦', 'info');

  try {
    // 1. DÃ­as
    const dias = await fetchColA('Dias');
    if (!dias.length) throw new Error('Hoja "Dias" sin datos vÃ¡lidos');
    cacheSet(CACHE_KEYS.dias, dias);
    setProgress(30);
    if (!silent) log(`âœ“ DÃ­as cargados: [${dias.join(', ')}]`, 'ok');

    // 2. Capital
    const capital = await fetchColA('Capital');
    if (!capital.length) throw new Error('Hoja "Capital" sin datos vÃ¡lidos');
    cacheSet(CACHE_KEYS.capital, capital);
    setProgress(55);
    if (!silent) log(`âœ“ Capitales: ${capital.length} montos`, 'ok');

    // 3. InterÃ©s
    const interes = await fetchInteres(dias);
    if (!Object.keys(interes).length) throw new Error('Hoja "Interes" sin tasas vÃ¡lidas');
    cacheSet(CACHE_KEYS.interes, interes);
    setProgress(80);
    if (!silent) log(`âœ“ Tasas: ${Object.keys(interes).length} combinaciones`, 'ok');

    // 4. Banner
    const banner = await fetchBanner();
    cacheSet(CACHE_KEYS.banner, banner);
    setProgress(100);
    if (!silent) log('âœ“ Banner actualizado', 'ok');

    // Aplicar datos
    state.cache = { dias, capital, interes, banner };
    renderChips();
    renderBanner();
    updateStatus('online');
    updateSyncMeta();

    if (!silent) {
      log('SincronizaciÃ³n completa âœ“', 'ok');
      toast('âœ“ Datos actualizados');
    }

    setTimeout(() => setProgress(null), 700);
    $('btnSync').disabled = false;
    return true;

  } catch (err) {
    log(`âœ— Error: ${err.message}`, 'err');
    if (!silent) toast('âš ï¸ Error al sincronizar');
    updateStatus(navigator.onLine ? 'online' : 'offline');
    setTimeout(() => setProgress(null), 400);
    $('btnSync').disabled = false;
    return false;
  }
}

/* ============================================
   CARGAR DESDE CACHÃ‰
   ============================================ */
function cargarDesdeCache() {
  const d = cacheGet(CACHE_KEYS.dias);
  const c = cacheGet(CACHE_KEYS.capital);
  const i = cacheGet(CACHE_KEYS.interes);
  const b = cacheGet(CACHE_KEYS.banner);

  const ok = d?.data?.length && c?.data?.length && i?.data && Object.keys(i.data).length;

  if (ok) {
    state.cache.dias    = d.data;
    state.cache.capital = c.data;
    state.cache.interes = i.data;
    state.cache.banner  = b?.data || { activo:false, texto:'' };
    return true;
  }
  return false;
}

/* ============================================
   RENDER CHIPS
   ============================================ */
function renderChips() {
  // Plazos
  const cp = $('chipsPlazos');
  cp.innerHTML = '';
  if (!state.cache.dias.length) {
    cp.innerHTML = '<span style="color:var(--muted);font-size:.8rem">Sin datos â€” sincroniza primero</span>';
    return;
  }
  state.cache.dias.forEach(d => {
    const el = document.createElement('div');
    el.className = 'chip' + (state.plazo === d ? ' active' : '');
    el.textContent = d + ' dÃ­as';
    el.onclick = () => selectPlazo(d);
    cp.appendChild(el);
  });

  // Capital
  const cc = $('chipsCapital');
  cc.innerHTML = '';
  state.cache.capital.forEach(c => {
    const el = document.createElement('div');
    el.className = 'chip' + (state.capital === c ? ' active' : '');
    el.textContent = '$' + c.toLocaleString('es-MX');
    el.onclick = () => selectCapital(c);
    cc.appendChild(el);
  });

  checkBtn();
}

function selectPlazo(d) {
  state.plazo = d;
  document.querySelectorAll('#chipsPlazos .chip').forEach(el => {
    el.classList.toggle('active', parseInt(el.textContent) === d);
  });
  checkBtn();
}

function selectCapital(c) {
  state.capital = c;
  document.querySelectorAll('#chipsCapital .chip').forEach(el => {
    el.classList.toggle('active', el.textContent === '$' + c.toLocaleString('es-MX'));
  });
  checkBtn();
}

function checkBtn() {
  $('btnCalc').disabled = !(state.plazo && state.capital);
}

/* ============================================
   BANNER
   ============================================ */
function renderBanner() {
  const b = state.cache.banner;
  const el = $('banner');
  if (b?.activo && b?.texto?.trim()) {
    $('bannerText').textContent = b.texto;
    el.classList.add('show');
  } else {
    el.classList.remove('show');
  }
}

/* ============================================
   CALCULAR
   ============================================ */
function calcular(e) {
  // Ripple
  const btn  = $('btnCalc');
  const rip  = document.createElement('span');
  rip.className = 'ripple';
  rip.style.cssText = `width:${btn.offsetWidth}px;height:${btn.offsetWidth}px;left:0;top:${(btn.offsetHeight - btn.offsetWidth)/2}px`;
  btn.appendChild(rip);
  setTimeout(() => rip.remove(), 520);

  const { plazo, capital, cache: { dias, capital: caps, interes } } = state;

  if (!plazo || !capital) { toast('Selecciona plazo y capital'); return; }
  if (!interes[plazo] && interes[plazo] !== 0) { toast('Sin tasa para ese plazo'); return; }

  const tasa         = interes[plazo];
  const interesTotal = capital * (tasa / 100);
  const totalPagar   = capital + interesTotal;
  const pagoDiario   = totalPagar / plazo;

  $('resultado').innerHTML = `
    <div class="result-card">
      <div class="result-header">
        <div class="label">Total a pagar</div>
        <div class="amount">${fmt(totalPagar)}</div>
        <div class="sub">en ${plazo} dÃ­as Â· ${tasa}% de interÃ©s</div>
      </div>

      <div class="result-grid">
        <div class="result-item">
          <div class="ri-label">Capital</div>
          <div class="ri-value">${fmt(capital)}</div>
        </div>
        <div class="result-item">
          <div class="ri-label">Tasa aplicada</div>
          <div class="ri-value accent">${tasa}%</div>
        </div>
        <div class="result-item">
          <div class="ri-label">InterÃ©s generado</div>
          <div class="ri-value gold">${fmt(interesTotal)}</div>
        </div>
        <div class="result-item">
          <div class="ri-label">Pago diario</div>
          <div class="ri-value accent">${fmt(pagoDiario)}</div>
        </div>
      </div>

      <div class="cache-badge">
        <div class="dot"></div>
        Calculado con datos del cachÃ© local Â· ${new Date().toLocaleTimeString('es-MX', {hour:'2-digit',minute:'2-digit'})}
      </div>
    </div>`;
}

/* ============================================
   SYNC PANEL TOGGLE
   ============================================ */
function toggleSync() {
  const panel  = $('syncPanel');
  const toggle = $('syncToggle');
  const show   = !panel.classList.contains('show');
  panel.classList.toggle('show', show);
  toggle.classList.toggle('open', show);
}

function updateSyncMeta() {
  const ts = cacheLastSync();
  const d  = cacheGet(CACHE_KEYS.dias);
  const c  = cacheGet(CACHE_KEYS.capital);
  const i  = cacheGet(CACHE_KEYS.interes);
  const ok = d?.data?.length && c?.data?.length && i?.data;

  $('syncCacheInfo').textContent = ok
    ? `${d.data.length} plazos Â· ${c.data.length} montos Â· ${Object.keys(i.data).length} tasas`
    : 'Sin datos en cachÃ©';

  $('syncLastTime').textContent = ts
    ? new Date(ts).toLocaleString('es-MX', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' })
    : 'Nunca';
}

/* ============================================
   INIT
   ============================================ */
async function init() {
  updateStatus(navigator.onLine ? 'online' : 'offline');
  updateSyncMeta();

  const hasCached = cargarDesdeCache();
  const stale     = cacheIsStale(CACHE_KEYS.dias);

  if (hasCached) {
    // Datos en cachÃ©: renderizar de inmediato
    renderChips();
    renderBanner();
    updateSyncMeta();

    if (stale && navigator.onLine) {
      // Cache viejo: actualizar en background sin bloquear UI
      setTimeout(() => sincronizar(true), 800);
    }
  } else {
    // Sin cachÃ©: intentar sync activo
    if (navigator.onLine) {
      await sincronizar(false);
      toggleSync(); // abrir panel para mostrar progreso la primera vez
    } else {
      $('chipsPlazos').innerHTML  = '<span style="color:var(--muted);font-size:.8rem">ðŸ“µ Sin conexiÃ³n â€” no hay datos guardados</span>';
      $('chipsCapital').innerHTML = '';
      toast('Sin conexiÃ³n y sin cachÃ© local', 3500);
      updateStatus('offline');
    }
  }

  // Listeners de conectividad
  window.addEventListener('online',  () => { updateStatus('online');  sincronizar(true); });
  window.addEventListener('offline', () => { updateStatus('offline'); toast('ðŸ“µ Modo offline â€” usando cachÃ©'); });
}

init();
</script>
</body>
</html>

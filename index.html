<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ Clone Offline - Simulador (Auto)</title>
    <style>
        /* Todo el CSS original se mantiene igual â€“ no lo repito aquÃ­ para no alargar */
        /* Copia exactamente el <style> que tenÃ­as en tu archivo original */
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ Clone Offline (Auto)</h1>
        <p class="subtitle">Pre-carga automÃ¡tica de datos para funcionar sin internet</p>
        
        <!-- CONTROLES PRINCIPALES (los dejamos visibles por si quieres usarlos manualmente) -->
        <div class="control-section">
            <h2>âš™ï¸ Controles</h2>
            <div class="button-group">
                <button class="btn btn-primary" id="btnCargar">ğŸ“¥ Cargar Datos</button>
                <button class="btn btn-secondary" id="btnVerificar">ğŸ” Verificar</button>
                <button class="btn btn-danger" id="btnLimpiar">ğŸ—‘ï¸ Limpiar</button>
            </div>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <!-- AUTO-ACTUALIZACIÃ“N -->
        <div class="toggle-section">
            <div>
                <strong>Auto-actualizaciÃ³n al conectar</strong>
                <div style="font-size: 0.85em; color: #666; margin-top: 3px;">
                    Cargar datos automÃ¡ticamente cuando detecte internet
                </div>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="toggleAuto">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <!-- STATUS -->
        <div class="status-box">
            <h3>ğŸ“Š Estado Actual</h3>
            <div id="statusContainer">
                <div class="status-message status-info">â³ Iniciando carga automÃ¡tica...</div>
            </div>
        </div>
        
        <!-- ESTADÃSTICAS -->
        <div class="data-section">
            <h3>ğŸ“ˆ EstadÃ­sticas</h3>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="statDias">-</div><div class="stat-label">DÃ­as</div></div>
                <div class="stat-card"><div class="stat-value" id="statCapital">-</div><div class="stat-label">Capitales</div></div>
                <div class="stat-card"><div class="stat-value" id="statInteres">-</div><div class="stat-label">Intereses</div></div>
                <div class="stat-card"><div class="stat-value" id="statBanner">-</div><div class="stat-label">Banner</div></div>
            </div>
        </div>
        
        <!-- DATOS EN LOCALSTORAGE -->
        <div class="data-section">
            <h3>ğŸ’¾ Datos en localStorage</h3>
            <div class="data-item"><div class="data-label">ğŸ“… DIAS</div><div class="data-value" id="displayDias">-</div></div>
            <div class="data-item"><div class="data-label">ğŸ’° CAPITAL</div><div class="data-value" id="displayCapital">-</div></div>
            <div class="data-item"><div class="data-label">ğŸ“Š INTERES</div><div class="data-value" id="displayInteres">-</div></div>
            <div class="data-item"><div class="data-label">ğŸŒ BANNER</div><div class="data-value" id="displayBanner">-</div></div>
        </div>
        
        <!-- INFORMACIÃ“N -->
        <div class="data-section" style="background: #f0f4ff; border-color: #667eea;">
            <h3>â„¹ï¸ InformaciÃ³n</h3>
            <p style="color: #666;">Carga automÃ¡tica ejecutada al abrir la pÃ¡gina.<br>Si hay conexiÃ³n â†’ actualiza datos.<br>Sin conexiÃ³n â†’ usa lo guardado previamente.</p>
        </div>
    </div>

    <script>
        const SHEET_ID = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
        let autoUpdateEnabled = localStorage.getItem('auto_update') === 'true';

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FUNCIONES DE CACHÃ‰ (igual que antes)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function saveToCache(key, data) {
            try {
                const cacheData = { data, timestamp: Date.now() };
                localStorage.setItem(`simulador_${key}`, JSON.stringify(cacheData));
                return true;
            } catch {
                return false;
            }
        }

        function getFromCache(key) {
            try {
                const cached = localStorage.getItem(`simulador_${key}`);
                if (!cached) return null;
                const parsed = JSON.parse(cached);
                return parsed.data;
            } catch {
                return null;
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CARGA DE COLUMNA (igual)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadColumnFromSheet(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 10000);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeout);
                if (!response.ok) throw new Error('Error en ' + sheetName);
                const text = await response.text();
                let jsonStr = text.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);[\s\S]*$/, '');
                const json = JSON.parse(jsonStr);
                const rows = json.table.rows || [];
                const valores = rows.map(r => r.c?.[0]?.v).filter(v => v != null).map(v => parseFloat(v)).filter(n => !isNaN(n));
                return valores;
            } catch (error) {
                clearTimeout(timeout);
                throw error;
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CARGA DE BANNER (igual)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadBannerFromSheet() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Banner`;
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 10000);
            
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeout);
                if (!response.ok) throw new Error();
                const text = await response.text();
                const jsonStr = text.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);[\s\S]*$/, '');
                const json = JSON.parse(jsonStr);
                const rows = json.table.rows || [];
                if (rows.length > 1) {
                    const msg = rows[1]?.c?.[0]?.v?.trim?.() || '';
                    return { activo: !!msg, texto: msg };
                }
                return { activo: false, texto: '' };
            } catch {
                clearTimeout(timeout);
                return { activo: false, texto: '' };
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // CARGA AUTOMÃTICA AL ABRIR LA PÃGINA (esto reemplaza el botÃ³n)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function autoLoadOnStart() {
            const status = document.getElementById('statusContainer');
            status.innerHTML = '<div class="status-message status-info">â³ Iniciando carga automÃ¡tica...</div>';

            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            progressContainer.classList.add('show');
            progressBar.style.width = '0%';

            try {
                // Paso 1: Dias
                status.innerHTML += '<div class="status-message status-info">ğŸ“… Cargando Dias...</div>';
                progressBar.style.width = '25%';
                const dias = await loadColumnFromSheet('Dias');
                saveToCache('dias', dias);

                // Paso 2: Capital
                status.innerHTML += '<div class="status-message status-info">ğŸ’° Cargando Capital...</div>';
                progressBar.style.width = '50%';
                const capital = await loadColumnFromSheet('Capital');
                saveToCache('capital', capital);

                // Paso 3: Interes
                status.innerHTML += '<div class="status-message status-info">ğŸ“Š Cargando Interes...</div>';
                progressBar.style.width = '75%';
                const interes = await loadColumnFromSheet('Interes');
                saveToCache('interes', interes);

                // Paso 4: Banner
                status.innerHTML += '<div class="status-message status-info">ğŸŒ Cargando Banner...</div>';
                progressBar.style.width = '90%';
                const banner = await loadBannerFromSheet();
                saveToCache('banner_config', banner);

                // Final
                progressBar.style.width = '100%';
                status.innerHTML += '<div class="status-message status-success"><strong>ğŸ‰ Datos cargados/actualizados automÃ¡ticamente</strong></div>';
                mostrarDatosEnPantalla();
            } catch (err) {
                progressBar.style.width = '100%';
                progressBar.style.background = '#FF6B6B';
                status.innerHTML += `<div class="status-message status-error">âŒ Error: ${err.message}</div>`;
                status.innerHTML += '<div class="status-message status-info">â„¹ï¸ Usando datos guardados previamente (si existen)</div>';
                mostrarDatosEnPantalla();
            } finally {
                progressContainer.classList.remove('show');
                progressBar.style.width = '0%';
                progressBar.style.background = 'white';
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Funciones de UI (se mantienen iguales)
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function mostrarDatosEnPantalla() {
            const dias = getFromCache('dias');
            const capital = getFromCache('capital');
            const interes = getFromCache('interes');
            const banner = getFromCache('banner_config');

            document.getElementById('displayDias').innerHTML = dias ? JSON.stringify(dias) : '<span class="data-empty">Sin datos</span>';
            document.getElementById('displayCapital').innerHTML = capital ? JSON.stringify(capital) : '<span class="data-empty">Sin datos</span>';
            document.getElementById('displayInteres').innerHTML = interes ? JSON.stringify(interes) : '<span class="data-empty">Sin datos</span>';
            document.getElementById('displayBanner').innerHTML = banner ? JSON.stringify(banner) : '<span class="data-empty">Sin datos</span>';

            document.getElementById('statDias').textContent = dias ? dias.length : '0';
            document.getElementById('statCapital').textContent = capital ? capital.length : '0';
            document.getElementById('statInteres').textContent = interes ? interes.length : '0';
            document.getElementById('statBanner').textContent = banner && banner.activo ? 'âœ“' : 'âœ—';
        }

        function verificarDatos() {
            const status = document.getElementById('statusContainer');
            status.innerHTML = '<div class="status-message status-info">ğŸ” Verificando cachÃ©...</div>';

            const dias = getFromCache('dias');
            const capital = getFromCache('capital');
            const interes = getFromCache('interes');
            const banner = getFromCache('banner_config');

            let todos = true;

            status.innerHTML += dias?.length > 0 
                ? `<div class="status-message status-success">âœ… DIAS: ${dias.length}</div>`
                : '<div class="status-message status-error">âŒ DIAS no encontrado</div>';
            todos = todos && dias?.length > 0;

            status.innerHTML += capital?.length > 0 
                ? `<div class="status-message status-success">âœ… CAPITAL: ${capital.length}</div>`
                : '<div class="status-message status-error">âŒ CAPITAL no encontrado</div>';
            todos = todos && capital?.length > 0;

            status.innerHTML += interes?.length > 0 
                ? `<div class="status-message status-success">âœ… INTERES: ${interes.length}</div>`
                : '<div class="status-message status-error">âŒ INTERES no encontrado</div>';
            todos = todos && interes?.length > 0;

            status.innerHTML += banner 
                ? `<div class="status-message status-success">âœ… BANNER: ${banner.activo ? 'Activo' : 'Inactivo'}</div>`
                : '<div class="status-message status-warning">âš ï¸ BANNER no encontrado</div>';

            if (todos) {
                status.innerHTML += '<div class="status-message status-success"><strong>ğŸ‰ Todo listo para offline</strong></div>';
            } else {
                status.innerHTML += '<div class="status-message status-warning">âš ï¸ Faltan datos</div>';
            }

            mostrarDatosEnPantalla();
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // AUTO-EJECUCIÃ“N AL CARGAR LA PÃGINA
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar estado del toggle
            document.getElementById('toggleAuto').checked = autoUpdateEnabled;

            // 1. Verificar lo que ya hay
            verificarDatos();

            // 2. Intentar actualizar automÃ¡ticamente
            autoLoadOnStart();

            // 3. Escuchar reconexiÃ³n
            window.addEventListener('online', () => {
                if (autoUpdateEnabled) {
                    const status = document.getElementById('statusContainer');
                    status.innerHTML += '<div class="status-message status-success">ConexiÃ³n detectada â†’ actualizando...</div>';
                    autoLoadOnStart();
                }
            });
        });
    </script>
</body>
</html>

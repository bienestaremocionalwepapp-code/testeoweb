<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SimPrÃ©stamo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<style>
:root {
  --bg:       #080b10;
  --surface:  #0f1319;
  --card:     #141a24;
  --card2:    #19202e;
  --border:   #1c2535;
  --border2:  #243047;
  --accent:   #00e5b0;
  --accent-d: #00b88d;
  --blue:     #3b82f6;
  --gold:     #f59e0b;
  --danger:   #ef4444;
  --text:     #dce8f5;
  --muted:    #4d617d;
  --soft:     #7a92b0;
  --r:        12px;
  --r-sm:     8px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100vh;overflow-x:hidden;
}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 55% 45% at 85% 5%,  rgba(0,229,176,.06) 0%,transparent 65%),
    radial-gradient(ellipse 45% 55% at 5%  95%, rgba(59,130,246,.05) 0%,transparent 65%);
}

.app{position:relative;z-index:1;max-width:440px;margin:0 auto;padding:0 16px 56px}

/* â”€â”€ HEADER â”€â”€ */
.header{display:flex;align-items:center;justify-content:space-between;padding:22px 0 10px}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.3rem;letter-spacing:-.03em}
.logo em{color:var(--accent);font-style:normal}

.pill{
  display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:99px;
  font-size:.7rem;font-weight:500;letter-spacing:.05em;text-transform:uppercase;
  border:1px solid var(--border2);background:var(--surface);transition:all .35s;
}
.pill.online { border-color:rgba(0,229,176,.35); color:var(--accent) }
.pill.offline{ border-color:rgba(245,158,11,.35); color:var(--gold)   }
.pill.sync   { border-color:rgba(59,130,246,.35);  color:var(--blue)   }
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:blink 1.8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ BANNER â”€â”€ */
.banner{
  display:none;align-items:center;gap:9px;margin:6px 0;padding:10px 14px;
  border-radius:var(--r-sm);background:rgba(0,229,176,.07);
  border:1px solid rgba(0,229,176,.18);font-size:.83rem;color:var(--accent);
  animation:up .3s ease;
}
.banner.show{display:flex}

/* â”€â”€ SECTION â”€â”€ */
.stitle{
  font-family:'Syne',sans-serif;font-size:.66rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin:26px 0 10px;
}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px}

/* â”€â”€ CHIPS â”€â”€ */
.clabel{font-size:.75rem;font-weight:500;color:var(--soft);display:flex;align-items:center;gap:6px;margin-bottom:10px}
.chips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:20px}
.chips.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}

.chip{
  padding:8px 16px;border-radius:99px;border:1.5px solid var(--border2);background:var(--surface);
  color:var(--soft);font-size:.82rem;font-weight:500;cursor:pointer;user-select:none;transition:all .15s;
}
.chips.grid .chip{border-radius:var(--r-sm);text-align:center;padding:10px 6px}
.chip:hover{border-color:var(--accent);color:var(--text)}
.chip.on{border-color:var(--accent);background:rgba(0,229,176,.1);color:var(--accent);font-weight:600}

.sk{
  background:linear-gradient(90deg,var(--surface) 25%,var(--card2) 50%,var(--surface) 75%);
  background-size:200% 100%;animation:sh 1.2s infinite;border-radius:99px;height:36px;
}
.chips.grid .sk{border-radius:var(--r-sm)}
@keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

.divider{height:1px;background:var(--border);margin:0 0 20px}

/* â”€â”€ BTN â”€â”€ */
.btn-calc{
  width:100%;padding:15px;border-radius:var(--r);border:none;
  background:linear-gradient(135deg,var(--accent) 0%,var(--accent-d) 100%);
  color:#001a12;font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;
  letter-spacing:.02em;cursor:pointer;
  box-shadow:0 4px 20px rgba(0,229,176,.2);
  transition:all .2s;position:relative;overflow:hidden;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn-calc:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 8px 28px rgba(0,229,176,.3)}
.btn-calc:active:not(:disabled){transform:translateY(0)}
.btn-calc:disabled{opacity:.35;cursor:not-allowed}
.rip{
  position:absolute;border-radius:50%;background:rgba(255,255,255,.2);
  transform:scale(0);animation:rip .5s linear;pointer-events:none;
}
@keyframes rip{to{transform:scale(5);opacity:0}}

/* â”€â”€ RESULTADO â”€â”€ */
.result{
  margin-top:18px;border-radius:var(--r);overflow:hidden;
  border:1px solid rgba(0,229,176,.22);
  box-shadow:0 0 40px rgba(0,229,176,.08),0 8px 32px rgba(0,0,0,.4);
  animation:up .35s ease;
}
@keyframes up{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

.rhead{
  padding:22px 20px 16px;text-align:center;
  background:linear-gradient(135deg,rgba(0,229,176,.1) 0%,rgba(59,130,246,.07) 100%);
  border-bottom:1px solid rgba(0,229,176,.12);
}
.rhead .rlabel{font-size:.68rem;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px}
.rhead .rbig{font-family:'Syne',sans-serif;font-size:2.5rem;font-weight:800;color:var(--accent);letter-spacing:-.04em;line-height:1}
.rhead .rsub{font-size:.77rem;color:var(--soft);margin-top:5px}

.rgrid{display:grid;grid-template-columns:1fr 1fr}
.ritem{padding:15px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
.ritem:nth-child(2n){border-right:none}
.ritem:nth-last-child(-n+2){border-bottom:none}
.rik{font-size:.67rem;color:var(--muted);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.riv{font-family:'Syne',sans-serif;font-size:1.12rem;font-weight:700;color:var(--text)}
.riv.ac{color:var(--accent)}
.riv.go{color:var(--gold)}

.rfooter{
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:9px;background:var(--surface);font-size:.68rem;color:var(--muted);
}
.rfooter .fdot{width:5px;height:5px;border-radius:50%;background:var(--accent)}

/* â”€â”€ STATUS BAR â”€â”€ */
.statusbar{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  margin-top:12px;padding:10px 14px;border-radius:var(--r-sm);
  background:var(--surface);border:1px solid var(--border);font-size:.73rem;color:var(--muted);
}
.statusbar .sl{display:flex;align-items:center;gap:7px;min-width:0;flex:1}
.statusbar .sl span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sdot{width:5px;height:5px;border-radius:50%;background:var(--accent);flex-shrink:0}
.sdot.warn{background:var(--gold)}
.sdot.err{background:var(--danger)}

.statusbar button{
  flex-shrink:0;background:none;border:1px solid var(--border2);
  padding:4px 10px;border-radius:99px;color:var(--soft);font-size:.68rem;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.statusbar button:hover{border-color:var(--accent);color:var(--accent)}
.statusbar button:disabled{opacity:.3;cursor:not-allowed}

.progress{height:2px;border-radius:99px;background:var(--border);overflow:hidden;margin-top:10px;display:none}
.progress.show{display:block}
.pfill{height:100%;width:0%;border-radius:99px;background:linear-gradient(90deg,var(--accent),var(--blue));transition:width .4s}

.synclog{
  font-size:.71rem;font-family:monospace;background:var(--bg);
  border:1px solid var(--border);border-radius:var(--r-sm);
  padding:10px 12px;line-height:1.9;max-height:110px;overflow-y:auto;
  margin-top:10px;display:none;color:var(--muted);
}
.synclog.show{display:block}
.lok{color:var(--accent)}.lw{color:var(--gold)}.le{color:var(--danger)}.li{color:var(--blue)}

#toast{
  position:fixed;bottom:22px;left:50%;
  transform:translateX(-50%) translateY(56px);
  background:var(--card2);border:1px solid var(--border2);
  padding:10px 20px;border-radius:99px;font-size:.81rem;color:var(--text);
  box-shadow:0 8px 24px rgba(0,0,0,.5);
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;z-index:100;pointer-events:none;
}
#toast.show{transform:translateX(-50%) translateY(0)}

.empty{padding:24px 0;text-align:center;font-size:.82rem;color:var(--muted);line-height:1.6}
.empty span{font-size:1.8rem;display:block;margin-bottom:8px;opacity:.4}

@media(max-width:360px){
  .rhead .rbig{font-size:2rem}
  .chips.grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">

  <header class="header">
    <div class="logo">Sim<em>PrÃ©stamo</em></div>
    <div class="pill" id="pill"><div class="dot"></div><span id="pillTxt">â€”</span></div>
  </header>

  <div class="banner" id="banner"><span>ğŸ“¢</span><span id="bannerTxt"></span></div>

  <p class="stitle">Simulador de prÃ©stamo</p>

  <div class="card">
    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      Plazo
    </div>
    <div class="chips" id="chipsDias">
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
    </div>

    <div class="divider"></div>

    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
      Capital solicitado
    </div>
    <div class="chips grid" id="chipsCapital">
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
    </div>

    <button class="btn-calc" id="btnCalc" disabled onclick="calcular(event)">
      Calcular prÃ©stamo
    </button>
  </div>

  <div id="resultado"></div>

  <div class="statusbar" id="statusBar">
    <div class="sl"><div class="sdot" id="sbarDot"></div><span id="sbarTxt">Iniciandoâ€¦</span></div>
    <button id="sbarBtn" onclick="syncManual()" disabled>â†» Sync</button>
  </div>

  <div class="progress" id="progress"><div class="pfill" id="pfill"></div></div>
  <div class="synclog" id="synclog"></div>

</div>
<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SHEET_ID  = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
const CACHE_TTL = 12 * 60 * 60 * 1000; // 12 h

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTADO EN MEMORIA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let SEL   = { dias: null, capital: null };
let CACHE = { dias:[], capital:[], interes:{}, banner:{activo:false,texto:''} };
let syncActivo = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCALSTORAGE â€” mismas claves que el test:
   simulador_dias, simulador_capital,
   simulador_interes, simulador_banner
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveToCache(key, data) {
  localStorage.setItem('simulador_' + key, JSON.stringify({ data, timestamp: Date.now() }));
}

function getFromCache(key) {
  try {
    const raw = localStorage.getItem('simulador_' + key);
    if (!raw) return null;
    const p = JSON.parse(raw);
    // Soporta formato antiguo (dato directo) y nuevo (con wrapper {data,timestamp})
    return p?.data !== undefined ? p.data : p;
  } catch(e) { return null; }
}

function getCacheTs(key) {
  try {
    const raw = localStorage.getItem('simulador_' + key);
    if (!raw) return null;
    return JSON.parse(raw)?.timestamp || null;
  } catch(e) { return null; }
}

function cacheCompleto() {
  const d = getFromCache('dias');
  const c = getFromCache('capital');
  const i = getFromCache('interes');
  return Array.isArray(d) && d.length > 0
      && Array.isArray(c) && c.length > 0
      && i && Object.keys(i).length > 0;
}

function cargarEnMemoria() {
  CACHE.dias    = getFromCache('dias')    || [];
  CACHE.capital = getFromCache('capital') || [];
  CACHE.interes = getFromCache('interes') || {};
  CACHE.banner  = getFromCache('banner')  || { activo:false, texto:'' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NORMALIZACIÃ“N â€” idÃ©ntica al test original
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function norm(v) {
  if (typeof v === 'number') return isFinite(v) ? v : NaN;
  if (v == null || v === '') return NaN;
  let s = String(v).trim().replace(/%/g,'').replace(/,/g,'.');
  const p = s.split('.');
  if (p.length > 2) s = p.slice(0,-1).join('') + '.' + p[p.length-1];
  const n = parseFloat(s);
  return isNaN(n) || !isFinite(n) ? NaN : n;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FETCH SHEETS â€” idÃ©ntico al test
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchSheet(nombre) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(nombre)}`;
  const r = await fetch(url, { cache:'no-store' });
  if (!r.ok) throw new Error(`HTTP ${r.status} en hoja "${nombre}"`);
  const txt = await r.text();
  const json = JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/,'').replace(/\);[\s\S]*$/,''));
  return json.table?.rows || [];
}

async function leerColumnaA(nombre) {
  const rows = await fetchSheet(nombre);
  const vals = [];
  rows.forEach((row, i) => {
    const v = row?.c?.[0]?.v;
    if (i === 0 && isNaN(parseFloat(v))) return; // saltar encabezado
    const n = norm(v);
    if (!isNaN(n)) vals.push(n);
  });
  return vals;
}

async function leerInteres(dias) {
  const rows = await fetchSheet('Interes');
  const vals = [];
  rows.forEach((row, i) => {
    const v = row?.c?.[0]?.v;
    const f = row?.c?.[0]?.f || '';
    if (i === 0 && isNaN(parseFloat(v))) return;
    let n = norm(v);
    if (isNaN(n) || n > 1000) return;                    // rechazar fechas
    if (f.includes('%') || (n > 0 && n < 1)) n *= 100;  // decimal â†’ porcentaje
    if (n < 0 || n > 100) return;
    vals.push(n);
  });
  // Mapear dÃ­as â†’ tasa (igual que el test)
  const obj = {};
  const len = Math.min(dias.length, vals.length);
  for (let i = 0; i < len; i++) obj[dias[i]] = vals[i];
  return obj;
}

async function leerBanner() {
  const rows = await fetchSheet('Banner');
  if (rows.length > 1) {
    const txt = rows[1]?.c?.[0]?.v || '';
    return { activo: txt.trim() !== '', texto: txt };
  }
  return { activo:false, texto:'' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SINCRONIZACIÃ“N
   Lee Sheets â†’ normaliza â†’ guarda localStorage
   (igual que leerDatosReales() del test)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sincronizar(silencioso = false) {
  if (syncActivo) return;
  if (!navigator.onLine) {
    if (!silencioso) toast('ğŸ“µ Sin conexiÃ³n');
    setPill('offline');
    return;
  }

  syncActivo = true;
  setPill('sync');
  setProgress(5);
  $('sbarBtn').disabled = true;

  if (!silencioso) {
    $('synclog').classList.add('show');
    addLog('Conectando con Google Sheetsâ€¦', 'i');
  }

  try {
    // 1. DÃ­as
    const dias = await leerColumnaA('Dias');
    if (!dias.length) throw new Error('"Dias" sin valores vÃ¡lidos');
    saveToCache('dias', dias);
    setProgress(28);
    if (!silencioso) addLog(`âœ“ DÃ­as: [${dias.join(', ')}]`, 'ok');

    // 2. Capital
    const capital = await leerColumnaA('Capital');
    if (!capital.length) throw new Error('"Capital" sin valores vÃ¡lidos');
    saveToCache('capital', capital);
    setProgress(54);
    if (!silencioso) addLog(`âœ“ Capital: ${capital.length} montos`, 'ok');

    // 3. InterÃ©s (mapeado dÃ­asâ†’tasa)
    const interes = await leerInteres(dias);
    if (!Object.keys(interes).length) throw new Error('"Interes" sin tasas vÃ¡lidas');
    saveToCache('interes', interes);
    setProgress(80);
    if (!silencioso) addLog(`âœ“ Tasas: ${Object.keys(interes).length} entradas`, 'ok');

    // 4. Banner
    const banner = await leerBanner();
    saveToCache('banner', banner);
    setProgress(100);
    if (!silencioso) addLog('âœ“ Banner ok', 'ok');

    // Cargar en memoria y renderizar
    cargarEnMemoria();
    renderDias();
    renderCapital();
    renderBanner();
    updateStatusBar();
    setPill('online');

    if (!silencioso) {
      addLog('Listo âœ“', 'ok');
      toast('âœ“ Datos actualizados');
    }

  } catch(err) {
    if (!silencioso) {
      addLog(`âœ— ${err.message}`, 'e');
      toast('âš  ' + err.message, 3500);
    }
    // Rescate: si hay cache aunque sea viejo, usarlo
    if (cacheCompleto()) {
      cargarEnMemoria();
      renderDias();
      renderCapital();
      renderBanner();
    }
    setPill(navigator.onLine ? 'online' : 'offline');
  }

  setTimeout(() => setProgress(null), 700);
  $('sbarBtn').disabled = false;
  syncActivo = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER CHIPS (desde CACHE en memoria)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDias() {
  const el = $('chipsDias');
  el.innerHTML = '';
  if (!CACHE.dias.length) {
    el.innerHTML = '<div class="empty"><span>ğŸ“…</span>Sin datos de plazos</div>';
    return;
  }
  CACHE.dias.forEach(d => {
    const c = mk('div','chip' + (SEL.dias===d?' on':''));
    c.textContent = d + ' dÃ­as';
    c.onclick = () => selDias(d);
    el.appendChild(c);
  });
  checkBtn();
}

function renderCapital() {
  const el = $('chipsCapital');
  el.innerHTML = '';
  if (!CACHE.capital.length) {
    el.innerHTML = '<div class="empty"><span>ğŸ’°</span>Sin datos de capital</div>';
    return;
  }
  CACHE.capital.forEach(c => {
    const chip = mk('div','chip' + (SEL.capital===c?' on':''));
    chip.textContent = '$' + c.toLocaleString('es-MX');
    chip.onclick = () => selCapital(c);
    el.appendChild(chip);
  });
  checkBtn();
}

function selDias(d) {
  SEL.dias = d;
  $$('#chipsDias .chip').forEach(c => c.classList.toggle('on', parseInt(c.textContent)===d));
  checkBtn();
}

function selCapital(c) {
  SEL.capital = c;
  $$('#chipsCapital .chip').forEach(el => el.classList.toggle('on', el.textContent==='$'+c.toLocaleString('es-MX')));
  checkBtn();
}

function checkBtn() { $('btnCalc').disabled = !(SEL.dias && SEL.capital); }

/* â”€â”€ Banner â”€â”€ */
function renderBanner() {
  const b = CACHE.banner;
  if (b?.activo && b.texto?.trim()) {
    $('bannerTxt').textContent = b.texto;
    $('banner').classList.add('show');
  } else {
    $('banner').classList.remove('show');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALCULAR â€” 100% desde cache en memoria
   FÃ³rmula idÃ©ntica a calcularDesdeCache() del test
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcular(e) {
  /* ripple visual */
  const btn = $('btnCalc');
  const sz  = Math.max(btn.offsetWidth, btn.offsetHeight);
  const r   = mk('span','rip');
  r.style.cssText = `width:${sz}px;height:${sz}px;left:${(btn.offsetWidth-sz)/2}px;top:${(btn.offsetHeight-sz)/2}px`;
  btn.appendChild(r); setTimeout(()=>r.remove(),520);

  const { dias, capital } = SEL;
  if (!dias || !capital)  { toast('Selecciona plazo y capital'); return; }

  const interesPorc = CACHE.interes[dias];
  if (interesPorc === undefined || interesPorc === null) { toast('âš  Sin tasa para ese plazo'); return; }

  /* FÃ“RMULA â€” igual que el test */
  const interesTotal = capital * (interesPorc / 100);
  const totalPagar   = capital + interesTotal;
  const pagoDiario   = totalPagar / dias;

  const hora = new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});

  $('resultado').innerHTML = `
    <div class="result">
      <div class="rhead">
        <div class="rlabel">Total a pagar</div>
        <div class="rbig">${fmt(totalPagar)}</div>
        <div class="rsub">${dias} dÃ­as Â· tasa ${interesPorc}%</div>
      </div>
      <div class="rgrid">
        <div class="ritem"><div class="rik">Capital</div><div class="riv">${fmt(capital)}</div></div>
        <div class="ritem"><div class="rik">Tasa</div><div class="riv ac">${interesPorc}%</div></div>
        <div class="ritem"><div class="rik">InterÃ©s total</div><div class="riv go">${fmt(interesTotal)}</div></div>
        <div class="ritem"><div class="rik">Pago diario</div><div class="riv ac">${fmt(pagoDiario)}</div></div>
      </div>
      <div class="rfooter"><div class="fdot"></div>Calculado con cachÃ© local Â· ${hora}</div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI UTILS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(n) { return '$' + n.toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2}); }
const $  = id  => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const mk = (tag,cls) => { const el=document.createElement(tag); if(cls) el.className=cls; return el; };

let _tTimer;
function toast(msg,ms=2800){
  clearTimeout(_tTimer);
  const el=$('toast'); el.textContent=msg; el.classList.add('show');
  _tTimer=setTimeout(()=>el.classList.remove('show'),ms);
}

function setPill(mode) {
  $('pill').className='pill '+mode;
  $('pillTxt').textContent={online:'Online',offline:'Offline',sync:'Sincronizando'}[mode]||mode;
}

function setProgress(pct) {
  const bar=$('progress');
  if(pct===null){bar.classList.remove('show');return;}
  bar.classList.add('show'); $('pfill').style.width=pct+'%';
}

function addLog(msg,type='i') {
  const el=$('synclog');
  const span=mk('span',{ok:'lok',w:'lw',e:'le',i:'li'}[type]||'li');
  const t=new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  span.textContent=`[${t}] ${msg}\n`;
  el.appendChild(span); el.scrollTop=el.scrollHeight;
}

function syncManual() {
  $('synclog').innerHTML='';
  $('synclog').classList.add('show');
  sincronizar(false);
}

function updateStatusBar() {
  const d  = getFromCache('dias');
  const c  = getFromCache('capital');
  const i  = getFromCache('interes');
  const ts = getCacheTs('dias');
  const ok = Array.isArray(d) && d.length && Array.isArray(c) && c.length && i && Object.keys(i).length;

  $('sbarDot').className = 'sdot' + (ok ? '' : ' err');
  $('sbarTxt').textContent = ok
    ? `CachÃ©: ${d.length} plazos Â· ${c.length} montos Â· ${ts ? new Date(ts).toLocaleString('es-MX',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}) : 'â€”'}`
    : 'Sin cachÃ© â€” sincroniza para comenzar';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT â€” flujo automÃ¡tico
   1. Hay cachÃ© â†’ cargar y renderizar al instante
   2. Si cachÃ© estÃ¡ vencido (>12h) â†’ sync bg silencioso
   3. Sin cachÃ© + online  â†’ sync con feedback visual
   4. Sin cachÃ© + offline â†’ mensaje de error
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init() {
  setPill(navigator.onLine ? 'online' : 'offline');
  updateStatusBar();

  if (cacheCompleto()) {
    /* â”€â”€ RUTA RÃPIDA: renderizar desde cachÃ© â”€â”€ */
    cargarEnMemoria();
    renderDias();
    renderCapital();
    renderBanner();
    $('sbarBtn').disabled = false;

    const ts    = getCacheTs('dias');
    const stale = !ts || (Date.now() - ts) > CACHE_TTL;
    if (stale && navigator.onLine) {
      // Refrescar en segundo plano sin interrumpir al usuario
      setTimeout(() => sincronizar(true), 1000);
    }

  } else {
    /* â”€â”€ PRIMERA VEZ o cachÃ© limpiado â”€â”€ */
    if (navigator.onLine) {
      $('synclog').classList.add('show');
      await sincronizar(false);
    } else {
      $('chipsDias').innerHTML  = '<div class="empty"><span>ğŸ“µ</span>Sin conexiÃ³n y sin datos guardados.<br>Conecta internet para la primera carga.</div>';
      $('chipsCapital').innerHTML = '';
      toast('Sin cachÃ© y sin conexiÃ³n', 3500);
    }
    $('sbarBtn').disabled = false;
  }

  /* Escuchar cambios de red */
  window.addEventListener('online',  () => {
    setPill('online'); toast('ConexiÃ³n restaurada');
    sincronizar(!cacheCompleto()); // silencioso si ya tiene datos, explÃ­cito si no
  });
  window.addEventListener('offline', () => {
    setPill('offline'); toast('ğŸ“µ Offline â€” operando con cachÃ©');
  });
}

init();
</script>
</body>
</html>
